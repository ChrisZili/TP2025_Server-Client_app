{% extends "layout.html" %}

{% block stylesheet %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/fotky_list.css') }}">
{% endblock %}

{% block title %}
Moji Lekári - Zoznam Fotiek
{% endblock %}

{% block header %}
Zoznam Fotiek
{% endblock %}

{% block content %}
<div id="fotky-list-container" style="padding: 20px;">
  <!-- Filters Section -->
  <div id="filters" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
    <!-- Dropdown for Oko -->
    <div>
      <label for="filter-eye">Oko:</label>
      <select id="filter-eye" class="form-input" onchange="applyFilters()">
        <option value="">Všetky</option>
        <option value="rigth">Pravé</option>
        <option value="left">Ľavé</option>
      </select>
    </div>

    <!-- Dropdowns for Admin -->
    {% if user_type == 'admin' %}
    <div>
      <label for="filter-patient">Pacient:</label>
      <select id="filter-patient" class="form-input" onchange="applyFilters()">
        <option value="">Všetci</option>
        {% for patient in patients %}
        <option value="{{ patient }}">{{ patient }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="filter-hospital">Nemocnica:</label>
      <select id="filter-hospital" class="form-input" onchange="applyFilters()">
        <option value="">Všetky</option>
        {% for hospital in hospitals %}
        <option value="{{ hospital }}">{{ hospital }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="filter-doctor">Doktor:</label>
      <select id="filter-doctor" class="form-input" onchange="applyFilters()">
        <option value="">Všetci</option>
        {% for doctor in doctors %}
        <option value="{{ doctor }}">{{ doctor }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>

  <!-- Table to display photos -->
  <table class="photo-table" style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="padding: 10px; text-align: left; cursor: pointer;" onclick="toggleSort('name')">Názov Fotky</th>
        <th style="padding: 10px; text-align: left; cursor: pointer;" onclick="toggleSort('date')">Dátum</th>
        <th style="padding: 10px; text-align: left; cursor: pointer;" onclick="toggleSort('eye')">Oko</th>
        <th style="padding: 10px; text-align: left; cursor: pointer;" onclick="toggleSort('patient')">Pacient</th>
        <th style="padding: 10px; text-align: left; cursor: pointer;" onclick="toggleSort('doctor')">Doktor</th>
        <th style="padding: 10px; text-align: left; cursor: pointer;" onclick="toggleSort('hospital')">Nemocnica</th>
      </tr>
    </thead>
    <tbody id="photo-table-body">
      {% for photo in photos %}
      <tr data-photo-name="{{ photo.name|urlencode }}" data-eye="{{ photo.eye }}" data-patient="{{ photo.patient }}" data-doctor="{{ photo.doctor }}" data-hospital="{{ photo.hospital }}">
        <td style="padding: 10px;">{{ photo.name|default('-', true) }}</td>
        <td style="padding: 10px;">{{ photo.date|default('-', true) }}</td>
        <td style="padding: 10px;">{{ photo.eye|default('-', true) }}</td>
        <td style="padding: 10px;">{{ photo.patient|default('-', true) }}</td>
        <td style="padding: 10px;">{{ photo.doctor|default('-', true) }}</td>
        <td style="padding: 10px;">{{ photo.hospital|default('-', true) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  let sortColumn = null;
  let sortAscending = true;

  function toggleSort(column) {
    if (sortColumn === column) {
      sortAscending = !sortAscending; // Toggle the sort order
    } else {
      sortColumn = column;
      sortAscending = true; // Default to ascending when switching columns
    }

    const rows = Array.from(document.querySelectorAll('#photo-table-body tr'));

    const sortedRows = rows.sort((a, b) => {
      const aValue = a.children[getColumnIndex(column)].textContent.trim();
      const bValue = b.children[getColumnIndex(column)].textContent.trim();

      if (column === 'date') {
        // Parse dates for comparison
        const dateA = parseDate(aValue);
        const dateB = parseDate(bValue);
        return sortAscending ? dateA - dateB : dateB - dateA;
      } else {
        // Compare strings
        return sortAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
      }
    });

    const tbody = document.getElementById('photo-table-body');
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
  }

  function getColumnIndex(column) {
    const columns = ['name', 'date', 'eye', 'patient', 'doctor', 'hospital'];
    return columns.indexOf(column);
  }

  function parseDate(dateString) {
    const [day, month, year] = dateString.split('.').map(Number);
    return new Date(year, month - 1, day); // Month is 0-indexed in JavaScript
  }

  function applyFilters() {
    const eyeFilter = document.getElementById('filter-eye').value.toLowerCase();
    const patientFilter = document.getElementById('filter-patient') ? document.getElementById('filter-patient').value.toLowerCase() : '';
    const hospitalFilter = document.getElementById('filter-hospital') ? document.getElementById('filter-hospital').value.toLowerCase() : '';
    const doctorFilter = document.getElementById('filter-doctor') ? document.getElementById('filter-doctor').value.toLowerCase() : '';

    const rows = document.querySelectorAll('#photo-table-body tr');

    rows.forEach(row => {
      const eye = row.dataset.eye.toLowerCase();
      const patient = row.dataset.patient.toLowerCase();
      const hospital = row.dataset.hospital.toLowerCase();
      const doctor = row.dataset.doctor.toLowerCase();

      const matchesEye = !eyeFilter || eye === eyeFilter;
      const matchesPatient = !patientFilter || patient === patientFilter;
      const matchesHospital = !hospitalFilter || hospital === hospitalFilter;
      const matchesDoctor = !doctorFilter || doctor === doctorFilter;

      if (matchesEye && matchesPatient && matchesHospital && matchesDoctor) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const tableBody = document.getElementById('photo-table-body');

    // Add a click event listener to the table body
    tableBody.addEventListener('click', (event) => {
      // Find the closest <tr> element that was clicked
      const row = event.target.closest('tr');
      if (row && row.dataset.photoName) {
        // Redirect to the photo detail page
        const photoName = row.dataset.photoName;
        window.location.href = `/fotky/detail/${photoName}`;
      }
    });
  });
</script>
{% endblock %}